#!/bin/bash
# NBA TUI Launcher

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${YELLOW}Initializing...${NC}"

# 1. Setup Data Service Environment (if missing)
if [ ! -d "data-service/venv" ]; then
    echo "Creating virtual environment..."
    python3 -m venv data-service/venv
fi

# 2. Ensure ascii-animator is installed (for loading screen)
if [ ! -f "data-service/venv/bin/ascii-art-animator" ]; then
    echo "Installing loading animation tools..."
    ./data-service/venv/bin/pip install ascii-animator >/dev/null 2>&1
fi

# 3. Start Data Service (Background)
echo "Starting backend..."
cd data-service
source venv/bin/activate
# Install requirements quiet
pip install -q -r requirements.txt >/dev/null 2>&1
# Kill existing
lsof -ti:8765 | xargs kill -9 2>/dev/null || true
# Start
python main.py > /dev/null 2>&1 &
DATA_SERVICE_PID=$!
cd ..

# 4. Start Loading Animation Loop + Background Data Prefetch
# We loop until data service is ready AND data is prefetched
while true; do
    # Check if backend is ready first
    if curl -s http://localhost:8765/health > /dev/null 2>&1; then
        # Backend is up! Start prefetching data in background
        curl -s "http://localhost:8765/games/today" > /dev/null 2>&1 &
        curl -s "http://localhost:8765/api/polymarket/odds" > /dev/null 2>&1 &
        curl -s "http://localhost:8765/games/standings" > /dev/null 2>&1 &
        
        # Play the animation once while data loads in background
        if [ -f "src/gif/loading.gif" ]; then
            # Play once (-m 1), very slow (-s very_slow = 1 second per frame)
            ./data-service/venv/bin/ascii-art-animator -f src/gif/loading.gif -m 1 -s very_slow
        else
            echo "Loading..."
            sleep 3
        fi
        break
    fi
    
    # Backend not ready yet, short wait
    sleep 0.5
done

clear

# 5. Run TUI
cleanup() {
    echo -e "\n${YELLOW}ðŸ›‘ Shutting down...${NC}"
    kill $DATA_SERVICE_PID 2>/dev/null || true
    exit 0
}
trap cleanup SIGINT SIGTERM

echo -e "${GREEN}âœ… Ready! Starting TUI...${NC}"
sleep 0.5
/opt/homebrew/bin/bun run start 2>/dev/null

cleanup
